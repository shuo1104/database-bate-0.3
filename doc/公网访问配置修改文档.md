# 公网访问配置修改文档

**修改日期**: 2025-11-18  
**配置方案**: 方案 B - 公网访问（使用公网 IP）  
**用途**: 临时测试公网访问功能

---

## ⚠️ 重要提示

- 本配置仅用于**临时测试**，测试完成后请立即恢复为本地访问配置
- 所有原始文件已备份为 `.backup` 后缀
- 使用 HTTP 协议，数据未加密，**不适合生产环境**
- 请妥善保管服务器公网 IP，避免泄露

---

## 📋 修改文件清单

### 1. 后端 CORS 配置
- **文件路径**: `data_base/backend_fastapi/app/config/settings.py`
- **备份文件**: `data_base/backend_fastapi/app/config/settings.py.backup`
- **修改内容**: 添加公网 IP 到 CORS 允许列表

### 2. 前端环境变量
- **文件路径**: `data_base/frontend_vue3/.env.production`
- **备份文件**: `data_base/frontend_vue3/.env.production.backup`
- **修改内容**: 修改后端 API 地址为公网 IP

### 3. Nginx 配置
- **文件路径**: `data_base/frontend_vue3/depoly/photopolymer-frontend.conf`
- **备份文件**: `data_base/frontend_vue3/depoly/photopolymer-frontend.conf.backup`
- **修改内容**: 允许所有 IP 访问

---

## 🔧 详细修改内容

### 修改 1: 后端 CORS 配置

**文件**: `backend_fastapi/app/config/settings.py`

**原始配置** (第 51-62 行):
```python
# ==================== CORS配置 ====================
CORS_ENABLE: bool = True
ALLOW_ORIGINS: List[str] = [
    "http://localhost:3000",    # frontend_vue3 开发服务器
    "http://localhost:5173",    # Vite 默认端口
    "http://localhost:5180",    # 其他前端服务
    "http://127.0.0.1:3000",
    "http://127.0.0.1:5173",
]
ALLOW_METHODS: List[str] = ["*"]
ALLOW_HEADERS: List[str] = ["*"]
ALLOW_CREDENTIALS: bool = True
```

**修改后配置**:
```python
# ==================== CORS配置 ====================
CORS_ENABLE: bool = True
ALLOW_ORIGINS: List[str] = [
    "http://localhost:3000",    # frontend_vue3 开发服务器
    "http://localhost:5173",    # Vite 默认端口
    "http://localhost:5180",    # 其他前端服务
    "http://127.0.0.1:3000",
    "http://127.0.0.1:5173",
    "http://YOUR_PUBLIC_IP:8080",  # 公网访问 - 请替换 YOUR_PUBLIC_IP 为实际公网IP
    "http://YOUR_PUBLIC_IP",       # 公网访问（80端口）
]
ALLOW_METHODS: List[str] = ["*"]
ALLOW_HEADERS: List[str] = ["*"]
ALLOW_CREDENTIALS: bool = True
```

**需要手动操作**: 将 `YOUR_PUBLIC_IP` 替换为您的实际公网 IP 地址

---

### 修改 2: 前端环境变量

**文件**: `frontend_vue3/.env.production`

**原始配置** (第 7-8 行):
```env
# 鍚庣鏈嶅姟鍦板潃
VITE_API_BASE_URL=https://your-production-domain.com
```

**修改后配置**:
```env
# 鍚庣鏈嶅姟鍦板潃
# 公网访问配置 - 请替换 YOUR_PUBLIC_IP 为实际公网IP
VITE_API_BASE_URL=http://YOUR_PUBLIC_IP:8080
```

**需要手动操作**: 将 `YOUR_PUBLIC_IP` 替换为您的实际公网 IP 地址

---

### 修改 3: Nginx 配置

**文件**: `frontend_vue3/depoly/photopolymer-frontend.conf`

**原始配置** (第 1-5 行):
```nginx
server {
    # 使用8080端口（80端口需要root权限）
    listen 8080;
    # 允许localhost和IP地址访问
    server_name localhost _;
```

**修改后配置**:
```nginx
server {
    # 使用8080端口（80端口需要root权限）
    listen 8080;
    # 允许所有IP地址访问（包括公网访问）
    server_name _;
```

---

## 🚀 部署步骤

### 步骤 1: 替换公网 IP 地址

**获取您的公网 IP**:
```bash
# 方法 1: 使用 curl
curl ifconfig.me

# 方法 2: 使用 wget
wget -qO- ifconfig.me

# 方法 3: 访问网站
# 浏览器打开: https://www.ip.cn/
```

**替换配置文件中的 YOUR_PUBLIC_IP**:
```bash
# 假设您的公网 IP 是 123.456.789.10
# 需要手动编辑以下文件，将 YOUR_PUBLIC_IP 替换为实际 IP

# 1. 编辑后端配置
nano data_base/backend_fastapi/app/config/settings.py
# 将第 59-60 行的 YOUR_PUBLIC_IP 替换为 123.456.789.10

# 2. 编辑前端配置
nano data_base/frontend_vue3/.env.production
# 将第 9 行的 YOUR_PUBLIC_IP 替换为 123.456.789.10
```

### 步骤 2: 重新构建前端

```bash
cd data_base/frontend_vue3
pnpm build
```

### 步骤 3: 更新 Nginx 配置

```bash
# 复制新的 Nginx 配置
sudo cp data_base/frontend_vue3/depoly/photopolymer-frontend.conf /etc/nginx/sites-available/photopolymer

# 测试 Nginx 配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

### 步骤 4: 重启后端服务

```bash
# 重启后端 API 服务
sudo systemctl restart photopolymer-api

# 查看服务状态
sudo systemctl status photopolymer-api
```

### 步骤 5: 配置防火墙

```bash
# 开放必要端口
sudo ufw allow 8080/tcp   # 前端端口
sudo ufw allow 8000/tcp   # 后端端口（可选）
sudo ufw reload

# 查看防火墙状态
sudo ufw status
```

### 步骤 6: 测试访问

```bash
# 从其他机器访问
http://YOUR_PUBLIC_IP:8080

# 测试后端 API
curl http://YOUR_PUBLIC_IP:8000/api/v1/health
```

---

## 🔙 恢复本地访问配置（重要！）

### 方法 1: 使用备份文件恢复（推荐）

**一键恢复脚本**:
```bash
#!/bin/bash
# 恢复所有配置文件到本地访问模式

echo "开始恢复配置文件..."

# 1. 恢复后端配置
if [ -f "data_base/backend_fastapi/app/config/settings.py.backup" ]; then
    cp data_base/backend_fastapi/app/config/settings.py.backup data_base/backend_fastapi/app/config/settings.py
    echo "✓ 后端配置已恢复"
else
    echo "✗ 后端配置备份文件不存在"
fi

# 2. 恢复前端配置
if [ -f "data_base/frontend_vue3/.env.production.backup" ]; then
    cp data_base/frontend_vue3/.env.production.backup data_base/frontend_vue3/.env.production
    echo "✓ 前端环境变量已恢复"
else
    echo "✗ 前端配置备份文件不存在"
fi

# 3. 恢复 Nginx 配置
if [ -f "data_base/frontend_vue3/depoly/photopolymer-frontend.conf.backup" ]; then
    cp data_base/frontend_vue3/depoly/photopolymer-frontend.conf.backup data_base/frontend_vue3/depoly/photopolymer-frontend.conf
    echo "✓ Nginx 配置已恢复"
else
    echo "✗ Nginx 配置备份文件不存在"
fi

echo ""
echo "配置文件恢复完成！"
echo "请执行以下命令完成恢复："
echo "  1. cd data_base/frontend_vue3 && pnpm build"
echo "  2. sudo cp data_base/frontend_vue3/depoly/photopolymer-frontend.conf /etc/nginx/sites-available/photopolymer"
echo "  3. sudo systemctl restart nginx"
echo "  4. sudo systemctl restart photopolymer-api"
```

**保存并执行**:
```bash
# 保存上述脚本为 restore_local_config.sh
chmod +x restore_local_config.sh
./restore_local_config.sh
```

### 方法 2: 手动恢复

**步骤 1: 恢复后端配置**
```bash
cp data_base/backend_fastapi/app/config/settings.py.backup data_base/backend_fastapi/app/config/settings.py
```

**步骤 2: 恢复前端配置**
```bash
cp data_base/frontend_vue3/.env.production.backup data_base/frontend_vue3/.env.production
```

**步骤 3: 恢复 Nginx 配置**
```bash
cp data_base/frontend_vue3/depoly/photopolymer-frontend.conf.backup data_base/frontend_vue3/depoly/photopolymer-frontend.conf
```

**步骤 4: 重新构建前端**
```bash
cd data_base/frontend_vue3
pnpm build
```

**步骤 5: 更新 Nginx 配置**
```bash
sudo cp data_base/frontend_vue3/depoly/photopolymer-frontend.conf /etc/nginx/sites-available/photopolymer
sudo nginx -t
sudo systemctl restart nginx
```

**步骤 6: 重启后端服务**
```bash
sudo systemctl restart photopolymer-api
```

**步骤 7: 关闭防火墙端口（可选）**
```bash
# 如果不再需要公网访问，可以关闭端口
sudo ufw delete allow 8080/tcp
sudo ufw delete allow 8000/tcp
sudo ufw reload
```

---

## 📊 配置对比表

| 配置项 | 本地访问模式 | 公网访问模式 |
|--------|------------|------------|
| **后端 CORS** | `localhost`, `127.0.0.1` | 添加公网 IP |
| **前端 API 地址** | `https://your-production-domain.com` | `http://YOUR_PUBLIC_IP:8080` |
| **Nginx server_name** | `localhost _` | `_` (所有) |
| **防火墙** | 无需开放外网端口 | 需开放 8080, 8000 |
| **安全性** | ✅ 高（仅本地） | ⚠️ 低（HTTP 明文） |
| **适用场景** | 生产环境 | 临时测试 |

---

## ⚠️ 安全注意事项

### 测试期间注意事项

1. **限制测试时间**
   - 建议测试时间不超过 24 小时
   - 测试完成后立即恢复本地配置

2. **监控访问日志**
   ```bash
   # 实时监控访问日志
   sudo tail -f /var/log/nginx/photopolymer-access.log

   # 查看后端日志
   sudo journalctl -u photopolymer-api -f
   ```

3. **使用强密码**
   - 确保管理员账号使用强密码
   - 避免使用默认密码 `admin123`

4. **数据备份**
   ```bash
   # 测试前备份数据库
   pg_dump -U postgres photopolymer_formulation_db > backup_$(date +%Y%m%d).sql
   ```

5. **限制访问 IP（可选）**
   - 如果只需要特定 IP 访问，可以在 Nginx 中配置白名单

### 测试完成后必做事项

- [ ] ✅ 恢复所有配置文件
- [ ] ✅ 重新构建前端
- [ ] ✅ 重启所有服务
- [ ] ✅ 关闭防火墙端口
- [ ] ✅ 验证只能本地访问
- [ ] ✅ 删除备份文件（可选）

---

