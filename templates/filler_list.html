{% extends "layout_embedded.html" %}

{% block title %}
无机材料信息列表
{% endblock %}

{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
        <div>
            <a href="{{ url_for('fillers.add_filler') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> 新建无机材料
            </a>
        </div>
        <div class="text-muted">
            <i class="bi bi-card-list"></i> 共 {{ total|default(0) }} 条记录，第 {{ page|default(1) }}/{{ total_pages|default(1) }} 页
        </div>
    </div>
    <div class="card-body">

    <form id="batch-form" method="POST" action="{{ url_for('fillers.filler_batch_action') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- 筛选栏 -->
            <div class="row mb-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small mb-1">类型</label>
                    <select id="filter-type" class="form-select form-select-sm">
                        <option value="">全部类型</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1">供应商</label>
                    <select id="filter-supplier" class="form-select form-select-sm">
                        <option value="">全部供应商</option>
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-center">
                    <button type="button" id="apply-filter" class="btn btn-info btn-sm me-2">
                        <i class="bi bi-funnel"></i> 筛选
                    </button>
                    <button type="button" id="reset-filter" class="btn btn-outline-secondary btn-sm me-3">
                        <i class="bi bi-arrow-counterclockwise"></i> 重置
                    </button>
                    <span id="filter-count" class="text-muted small"></span>
                </div>
            </div>
            
            <!-- 操作栏 -->
            <div class="row mb-3">
                <div class="col-md-12 d-flex align-items-center">
                    <div class="form-check me-3">
                        <input class="form-check-input" type="checkbox" id="filler-select-all">
                        <label class="form-check-label" for="filler-select-all">全选</label>
                    </div>
                    <button type="submit" id="filler-delete-btn" name="action" value="delete" class="btn btn-danger btn-sm" onclick="return confirm('您确定要删除所有选中的无机材料吗？');">
                        <i class="bi bi-trash"></i> 删除选中
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 5%;"></th>
                            <th>ID</th>
                            <th>商品名称</th>
                            <th>类型</th>
                            <th>供应商</th>
                            <th>粒径</th>
                            <th>是否硅烷化</th>
                            <th>比表面积</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for filler in fillers %}
                        <tr class="filler-row"
                            data-href="{{ url_for('fillers.edit_filler', filler_id=filler.FillerID) }}"
                            data-type="{{ filler.FillerTypeName or '' }}"
                            data-supplier="{{ filler.Supplier or '' }}">
                            <td><input class="form-check-input row-checkbox" type="checkbox" id="filler-checkbox-{{ filler.FillerID }}" name="selected_ids" value="{{ filler.FillerID }}"></td>
                            <td>{{ filler.FillerID }}</td>
                            <td>{{ filler.TradeName }}</td>
                            <td>{{ filler.FillerTypeName or 'N/A' }}</td>
                            <td>{{ filler.Supplier }}</td>
                            <td>{{ filler.ParticleSize }}</td>
                            <td>{% if filler.IsSilanized %}是{% else %}否{% endif %}</td>
                            <td>{{ filler.SurfaceArea }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center">没有找到任何无机材料记录。</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
        
        <!-- 分页导航 -->
        {% if total_pages > 1 %}
        <div class="mt-4">
            <nav aria-label="填料列表分页">
                <ul class="pagination justify-content-center mb-3">
                    <!-- 上一页 -->
                    <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                        <a class="page-link" href="{% if page > 1 %}{{ url_for('fillers.filler_list', page=page-1, per_page=per_page) }}{% else %}#{% endif %}" aria-label="上一页">
                            <i class="bi bi-chevron-left"></i> 上一页
                        </a>
                    </li>
                    
                    <!-- 首页 -->
                    {% if page > 3 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('fillers.filler_list', page=1, per_page=per_page) }}">1</a>
                    </li>
                    {% if page > 4 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    {% endif %}
                    
                    <!-- 中间页码 -->
                    {% for p in range([page-2, 1]|max, [page+2, total_pages]|min + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        {% if p == page %}
                        <span class="page-link">{{ p }}</span>
                        {% else %}
                        <a class="page-link" href="{{ url_for('fillers.filler_list', page=p, per_page=per_page) }}">{{ p }}</a>
                        {% endif %}
                    </li>
                    {% endfor %}
                    
                    <!-- 末页 -->
                    {% if page < total_pages - 2 %}
                    {% if page < total_pages - 3 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('fillers.filler_list', page=total_pages, per_page=per_page) }}">{{ total_pages }}</a>
                    </li>
                    {% endif %}
                    
                    <!-- 下一页 -->
                    <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                        <a class="page-link" href="{% if page < total_pages %}{{ url_for('fillers.filler_list', page=page+1, per_page=per_page) }}{% else %}#{% endif %}" aria-label="下一页">
                            下一页 <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <!-- 每页显示数量选择 -->
            <div class="text-center">
                <div class="btn-group btn-group-sm" role="group" aria-label="每页显示数量">
                    <span class="btn btn-sm btn-outline-secondary disabled">每页显示：</span>
                    <a href="{{ url_for('fillers.filler_list', page=1, per_page=10) }}" 
                       class="btn btn-sm btn-outline-primary {% if per_page == 10 %}active{% endif %}">10</a>
                    <a href="{{ url_for('fillers.filler_list', page=1, per_page=20) }}" 
                       class="btn btn-sm btn-outline-primary {% if per_page == 20 %}active{% endif %}">20</a>
                    <a href="{{ url_for('fillers.filler_list', page=1, per_page=50) }}" 
                       class="btn btn-sm btn-outline-primary {% if per_page == 50 %}active{% endif %}">50</a>
                    <a href="{{ url_for('fillers.filler_list', page=1, per_page=100) }}" 
                       class="btn btn-sm btn-outline-primary {% if per_page == 100 %}active{% endif %}">100</a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 为"新建无机材料"按钮添加过渡动画
    const addFillerBtn = document.querySelector('a.btn.btn-primary');
    if (addFillerBtn) {
        addFillerBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const targetUrl = this.href;
            
            // 通知父窗口显示加载遮罩
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'showLoading',
                    url: targetUrl
                }, '*');
            } else {
                document.body.style.transition = 'opacity 0.3s ease-out';
                document.body.style.opacity = '0';
                setTimeout(function() {
                    window.location.href = targetUrl;
                }, 300);
            }
        });
    }
    
    // Clickable table rows with transition animation (与导航栏切换相同的加载遮罩效果)
    document.querySelectorAll('tr[data-href]').forEach(row => {
        row.addEventListener('click', function(event) {
            if (event.target.type !== 'checkbox') {
                const targetUrl = this.dataset.href;
                
                // 通知父窗口显示加载遮罩
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'showLoading',
                        url: targetUrl
                    }, '*');
                } else {
                    // 如果不在 iframe 中，使用原来的淡出效果
                    document.body.style.transition = 'opacity 0.3s ease-out';
                    document.body.style.opacity = '0';
                    setTimeout(function() {
                        window.location = targetUrl;
                    }, 300);
                }
            }
        });
    });

    // 筛选功能
    const filterType = document.getElementById('filter-type');
    const filterSupplier = document.getElementById('filter-supplier');
    const applyFilterBtn = document.getElementById('apply-filter');
    const resetFilterBtn = document.getElementById('reset-filter');
    const filterCount = document.getElementById('filter-count');
    
    // 去重并填充下拉选项
    function populateFilterOptions() {
        const types = new Set();
        const suppliers = new Set();
        
        document.querySelectorAll('.filler-row').forEach(row => {
            const type = row.dataset.type;
            const supplier = row.dataset.supplier;
            if (type) types.add(type);
            if (supplier) suppliers.add(supplier);
        });
        
        // 清空并重新填充类型选项
        filterType.innerHTML = '<option value="">全部类型</option>';
        Array.from(types).sort().forEach(type => {
            filterType.innerHTML += `<option value="${type}">${type}</option>`;
        });
        
        // 清空并重新填充供应商选项
        filterSupplier.innerHTML = '<option value="">全部供应商</option>';
        Array.from(suppliers).sort().forEach(supplier => {
            filterSupplier.innerHTML += `<option value="${supplier}">${supplier}</option>`;
        });
    }
    
    populateFilterOptions();
    
    // 应用筛选
    function applyFilter() {
        const typeValue = filterType.value.toLowerCase();
        const supplierValue = filterSupplier.value.toLowerCase();
        
        let visibleCount = 0;
        let totalCount = 0;
        
        document.querySelectorAll('.filler-row').forEach(row => {
            totalCount++;
            const rowType = (row.dataset.type || '').toLowerCase();
            const rowSupplier = (row.dataset.supplier || '').toLowerCase();
            
            let show = true;
            
            // 类型筛选
            if (typeValue && rowType !== typeValue) {
                show = false;
            }
            
            // 供应商筛选
            if (supplierValue && rowSupplier !== supplierValue) {
                show = false;
            }
            
            // 显示或隐藏行
            if (show) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // 更新筛选计数
        if (visibleCount < totalCount) {
            filterCount.textContent = `显示 ${visibleCount} / ${totalCount} 条记录`;
        } else {
            filterCount.textContent = '';
        }
        
        // 更新全选功能
        updateSelectAll();
    }
    
    // 重置筛选
    function resetFilter() {
        filterType.value = '';
        filterSupplier.value = '';
        
        document.querySelectorAll('.filler-row').forEach(row => {
            row.style.display = '';
        });
        
        filterCount.textContent = '';
        updateSelectAll();
    }
    
    // 绑定事件
    applyFilterBtn.addEventListener('click', applyFilter);
    resetFilterBtn.addEventListener('click', resetFilter);
    
    // 按回车键应用筛选
    [filterType, filterSupplier].forEach(element => {
        element.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                applyFilter();
            }
        });
    });

    // Select all checkbox functionality (仅选中可见的行)
    const selectAllCheckbox = document.getElementById('filler-select-all');
    
    function updateSelectAll() {
        // 移除旧的事件监听器
        const newSelectAll = selectAllCheckbox.cloneNode(true);
        selectAllCheckbox.parentNode.replaceChild(newSelectAll, selectAllCheckbox);
        const selectAll = document.getElementById('filler-select-all');
        
        selectAll.addEventListener('change', function() {
            const visibleCheckboxes = Array.from(document.querySelectorAll('.row-checkbox'))
                .filter(cb => cb.closest('.filler-row').style.display !== 'none');
            
            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }
    
    updateSelectAll();
});
</script>
{% endblock %}
