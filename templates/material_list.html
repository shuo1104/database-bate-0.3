{% extends "layout_embedded.html" %}

{% block title %}
原料信息列表
{% endblock %}

{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
        <div>
            <a href="{{ url_for('materials.add_material') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> 新建原料
            </a>
        </div>
        <div class="text-muted">
            <i class="bi bi-card-list"></i> 共 {{ total|default(0) }} 条记录，第 {{ page|default(1) }}/{{ total_pages|default(1) }} 页
        </div>
    </div>
    <div class="card-body">

    <form id="batch-form" method="POST" action="{{ url_for('materials.material_batch_action') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- 筛选栏 -->
            <div class="row mb-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small mb-1">类别</label>
                    <select id="filter-category" class="form-select form-select-sm">
                        <option value="">全部类别</option>
                        {% for c in categories %}
                        <option value="{{ c }}" {% if filter_category==c %}selected{% endif %}>{{ c }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1">供应商</label>
                    <select id="filter-supplier" class="form-select form-select-sm">
                        <option value="">全部供应商</option>
                        {% for s in suppliers %}
                        <option value="{{ s }}" {% if filter_supplier==s %}selected{% endif %}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-center">
                    <button type="button" id="apply-filter" class="btn btn-info btn-sm me-2">
                        <i class="bi bi-funnel"></i> 筛选
                    </button>
                    <button type="button" id="reset-filter" class="btn btn-outline-secondary btn-sm me-3">
                        <i class="bi bi-arrow-counterclockwise"></i> 重置
                    </button>
                    <span id="filter-count" class="text-muted small"></span>
                </div>
            </div>
            
            <!-- 操作栏 -->
            <div class="row mb-3">
                <div class="col-md-12 d-flex align-items-center">
                    <div class="form-check me-3">
                        <input class="form-check-input" type="checkbox" id="material-select-all">
                        <label class="form-check-label" for="material-select-all">全选</label>
                    </div>
                    <button type="submit" id="material-delete-btn" name="action" value="delete" class="btn btn-danger btn-sm" onclick="return confirm('您确定要删除所有选中的原料吗？');">
                        <i class="bi bi-trash"></i> 删除选中
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 5%;"></th>
                            <th>ID</th>
                            <th>商品名称</th>
                            <th>类别</th>
                            <th>供应商</th>
                            <th>CAS号</th>
                            <th>密度</th>
                            <th>粘度</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for material in materials %}
                        <tr class="material-row" 
                            data-href="{{ url_for('materials.edit_material', material_id=material.MaterialID) }}"
                            data-category="{{ material.CategoryName or '' }}"
                            data-supplier="{{ material.Supplier or '' }}">
                            <td><input class="form-check-input row-checkbox" type="checkbox" id="material-checkbox-{{ material.MaterialID }}" name="selected_ids" value="{{ material.MaterialID }}"></td>
                            <td>{{ material.MaterialID }}</td>
                            <td>{{ material.TradeName }}</td>
                            <td>{{ material.CategoryName or 'N/A' }}</td>
                            <td>{{ material.Supplier }}</td>
                            <td>{{ material.CAS_Number }}</td>
                            <td>{{ material.Density }}</td>
                            <td>{{ material.Viscosity }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center">没有找到任何原料记录。</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
        
        <!-- 分页导航 -->
        {% if total_pages > 1 %}
        <div class="mt-4">
            <nav aria-label="原料列表分页">
                <ul class="pagination justify-content-center mb-3">
                    <!-- 上一页 -->
                    <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                        <a class="page-link" href="{% if page > 1 %}{{ url_for('materials.material_list', page=page-1, per_page=per_page, category=filter_category, supplier=filter_supplier, q=filter_q) }}{% else %}#{% endif %}" aria-label="上一页">
                            <i class="bi bi-chevron-left"></i> 上一页
                        </a>
                    </li>
                    
                    <!-- 首页 -->
                    {% if page > 3 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('materials.material_list', page=1, per_page=per_page, category=filter_category, supplier=filter_supplier, q=filter_q) }}">1</a>
                    </li>
                    {% if page > 4 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    {% endif %}
                    
                    <!-- 中间页码 -->
                    {% for p in range([page-2, 1]|max, [page+2, total_pages]|min + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        {% if p == page %}
                        <span class="page-link">{{ p }}</span>
                        {% else %}
                        <a class="page-link" href="{{ url_for('materials.material_list', page=p, per_page=per_page, category=filter_category, supplier=filter_supplier, q=filter_q) }}">{{ p }}</a>
                        {% endif %}
                    </li>
                    {% endfor %}
                    
                    <!-- 末页 -->
                    {% if page < total_pages - 2 %}
                    {% if page < total_pages - 3 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('materials.material_list', page=total_pages, per_page=per_page, category=filter_category, supplier=filter_supplier, q=filter_q) }}">{{ total_pages }}</a>
                    </li>
                    {% endif %}
                    
                    <!-- 下一页 -->
                    <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                        <a class="page-link" href="{% if page < total_pages %}{{ url_for('materials.material_list', page=page+1, per_page=per_page, category=filter_category, supplier=filter_supplier, q=filter_q) }}{% else %}#{% endif %}" aria-label="下一页">
                            下一页 <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <!-- 每页显示数量选择 -->
            <div class="text-center">
                <div class="btn-group btn-group-sm" role="group" aria-label="每页显示数量">
                    <span class="btn btn-sm btn-outline-secondary disabled">每页显示：</span>
                    <a href="{{ url_for('materials.material_list', page=1, per_page=10, category=filter_category, supplier=filter_supplier, q=filter_q) }}" 
                       class="btn btn-sm btn-outline-primary {% if per_page == 10 %}active{% endif %}">10</a>
                    <a href="{{ url_for('materials.material_list', page=1, per_page=20, category=filter_category, supplier=filter_supplier, q=filter_q) }}" 
                       class="btn btn-sm btn-outline-primary {% if per_page == 20 %}active{% endif %}">20</a>
                    <a href="{{ url_for('materials.material_list', page=1, per_page=50, category=filter_category, supplier=filter_supplier, q=filter_q) }}" 
                       class="btn btn-sm btn-outline-primary {% if per_page == 50 %}active{% endif %}">50</a>
                    <a href="{{ url_for('materials.material_list', page=1, per_page=100, category=filter_category, supplier=filter_supplier, q=filter_q) }}" 
                       class="btn btn-sm btn-outline-primary {% if per_page == 100 %}active{% endif %}">100</a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 为"新建原料"按钮添加过渡动画
    const addMaterialBtn = document.querySelector('a.btn.btn-primary');
    if (addMaterialBtn) {
        addMaterialBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const targetUrl = this.href;
            
                // 通知父窗口显示加载遮罩
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'showLoading',
                        url: targetUrl
                    }, '*');
                } else {
                    // 立即跳转，无延迟
                    window.location.href = targetUrl;
                }
        });
    }
    
    // Clickable table rows with transition animation (与导航栏切换相同的加载遮罩效果)
    document.querySelectorAll('tr[data-href]').forEach(row => {
        row.addEventListener('click', function(event) {
            if (event.target.type !== 'checkbox') {
                const targetUrl = this.dataset.href;
                
                // 通知父窗口显示加载遮罩
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'showLoading',
                        url: targetUrl
                    }, '*');
                } else {
                    // 立即跳转，无延迟
                    window.location = targetUrl;
                }
            }
        });
    });

    // 筛选功能（通过URL参数提交给服务端）
    const filterCategory = document.getElementById('filter-category');
    const filterSupplier = document.getElementById('filter-supplier');
    const applyFilterBtn = document.getElementById('apply-filter');
    const resetFilterBtn = document.getElementById('reset-filter');
    const filterCount = document.getElementById('filter-count');
    
    function applyFilter() {
        const params = new URLSearchParams(window.location.search);
        params.set('page', '1');
        params.set('per_page', '{{ per_page }}');
        const categoryVal = filterCategory.value || '';
        const supplierVal = filterSupplier.value || '';
        if (categoryVal) params.set('category', categoryVal); else params.delete('category');
        if (supplierVal) params.set('supplier', supplierVal); else params.delete('supplier');
        const url = '{{ url_for('materials.material_list') }}' + '?' + params.toString();
        window.location.href = url;
    }

    function resetFilter() {
        const params = new URLSearchParams(window.location.search);
        params.delete('category');
        params.delete('supplier');
        params.set('page', '1');
        params.set('per_page', '{{ per_page }}');
        const url = '{{ url_for('materials.material_list') }}' + '?' + params.toString();
        window.location.href = url;
    }
    
    // 绑定事件
    applyFilterBtn.addEventListener('click', applyFilter);
    resetFilterBtn.addEventListener('click', resetFilter);
    
    // 按回车键应用筛选
    [filterCategory, filterSupplier].forEach(element => {
        element.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                applyFilter();
            }
        });
    });

    // Select all checkbox functionality (仅选中可见的行)
    const selectAllCheckbox = document.getElementById('material-select-all');
    
    function updateSelectAll() {
        // 移除旧的事件监听器
        const newSelectAll = selectAllCheckbox.cloneNode(true);
        selectAllCheckbox.parentNode.replaceChild(newSelectAll, selectAllCheckbox);
        const selectAll = document.getElementById('material-select-all');
        
        selectAll.addEventListener('change', function() {
            const visibleCheckboxes = Array.from(document.querySelectorAll('.row-checkbox'))
                .filter(cb => cb.closest('.material-row').style.display !== 'none');
            
            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }
    
    updateSelectAll();
});

</script>
{% endblock %}
