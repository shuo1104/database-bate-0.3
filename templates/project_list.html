{% extends "layout_embedded.html" %}

{% block title %}
项目基本信息列表
{% endblock %}

{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
        <div>
            <a href="{{ url_for('projects.add_project') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> 新建项目
            </a>
        </div>
        <div class="text-muted">
            <i class="bi bi-card-list"></i> 共 {{ total|default(0) }} 条记录，第 {{ page|default(1) }}/{{ total_pages|default(1) }} 页
        </div>
    </div>
    <div class="card-body">
        <form id="control-form" method="POST" action="{{ url_for('projects.batch_action') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- 筛选栏 -->
            <div class="row mb-3 align-items-end">
                <div class="col-md-2">
                    <label class="form-label small mb-1">项目类型</label>
                    <select id="filter-type" class="form-select form-select-sm">
                        <option value="">全部类型</option>
                        {% for project in projects %}
                            {% if project.TypeName %}
                                <option value="{{ project.TypeName }}">{{ project.TypeName }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small mb-1">配方设计师</label>
                    <select id="filter-formulator" class="form-select form-select-sm">
                        <option value="">全部设计师</option>
                        {% for project in projects %}
                            {% if project.FormulatorName %}
                                <option value="{{ project.FormulatorName }}">{{ project.FormulatorName }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small mb-1">开始日期</label>
                    <input type="date" id="filter-date-start" class="form-control form-control-sm">
                </div>
                <div class="col-md-2">
                    <label class="form-label small mb-1">结束日期</label>
                    <input type="date" id="filter-date-end" class="form-control form-control-sm">
                </div>
                <div class="col-md-4 d-flex align-items-center">
                    <button type="button" id="apply-filter" class="btn btn-info btn-sm me-2">
                        <i class="bi bi-funnel"></i> 筛选
                    </button>
                    <button type="button" id="reset-filter" class="btn btn-outline-secondary btn-sm me-3">
                        <i class="bi bi-arrow-counterclockwise"></i> 重置
                    </button>
                    <span id="filter-count" class="text-muted small"></span>
                </div>
            </div>
            
            <!-- 操作栏 -->
            <div class="row mb-3">
                <div class="col-md-12 d-flex align-items-center">
                    <div class="form-check me-3">
                        <input class="form-check-input" type="checkbox" id="select-all">
                        <label class="form-check-label" for="select-all">
                            全选
                        </label>
                    </div>
                    <button type="submit" id="export-csv-btn" name="action" value="export_csv" class="btn btn-secondary btn-sm me-2">
                        <i class="bi bi-download"></i> 导出 (CSV)
                    </button>
                    <button type="submit" id="delete-selected-btn" name="action" value="delete" class="btn btn-danger btn-sm">
                        <i class="bi bi-trash"></i> 删除选中
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 5%;"></th>
                            <th style="width: 10%;">项目编号</th>
                            <th>项目名称</th>
                            <th>项目类型</th>
                            <th>配方设计师</th>
                            <th>设计日期</th>
                            <th>配方编码</th>
                            <th style="width: 10%;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in projects %}
                        <tr class="project-row" 
                            data-project-id="{{ project.ProjectID }}"
                            data-type="{{ project.TypeName or '' }}"
                            data-formulator="{{ project.FormulatorName or '' }}"
                            data-date="{{ project.FormulationDate.strftime('%Y-%m-%d') if project.FormulationDate else '' }}">
                            <td><input class="form-check-input row-checkbox" type="checkbox" id="checkbox-{{ project.ProjectID }}" name="selected_ids" value="{{ project.ProjectID }}"></td>
                            <td>{{ project.ProjectID }}</td>
                            <td>{{ project.ProjectName }}</td>
                            <td>{{ project.TypeName or 'N/A' }}</td>
                            <td>{{ project.FormulatorName }}</td>
                            <td>{{ project.FormulationDate.strftime('%Y-%m-%d') if project.FormulationDate }}</td>
                            <td>{{ project.FormulaCode }}</td>
                            <td>
                                <a href="{{ url_for('projects.edit_project', project_id=project.ProjectID) }}" class="btn btn-sm btn-outline-primary me-2">编辑</a>
                                <button class="btn btn-sm btn-info btn-details" data-project-id="{{ project.ProjectID }}">详情</button>
                            </td>
                        </tr>
                        <tr class="details-row" style="display: none;">
                            <td colspan="8"><div class="details-content p-3"></div></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center">没有找到任何项目记录。</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
        
        <!-- 分页导航 -->
        {% if total_pages > 1 %}
        <div class="mt-4">
            <nav aria-label="项目列表分页">
                <ul class="pagination justify-content-center mb-3">
                    <!-- 上一页 -->
                    <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                        <a class="page-link" href="{% if page > 1 %}{{ url_for('projects.project_list', page=page-1, per_page=per_page) }}{% else %}#{% endif %}" aria-label="上一页">
                            <i class="bi bi-chevron-left"></i> 上一页
                        </a>
                    </li>
                    
                    <!-- 首页 -->
                    {% if page > 3 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('projects.project_list', page=1, per_page=per_page) }}">1</a>
                    </li>
                    {% if page > 4 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    {% endif %}
                    
                    <!-- 中间页码 -->
                    {% for p in range([page-2, 1]|max, [page+2, total_pages]|min + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        {% if p == page %}
                        <span class="page-link">{{ p }}</span>
                        {% else %}
                        <a class="page-link" href="{{ url_for('projects.project_list', page=p, per_page=per_page) }}">{{ p }}</a>
                        {% endif %}
                    </li>
                    {% endfor %}
                    
                    <!-- 末页 -->
                    {% if page < total_pages - 2 %}
                    {% if page < total_pages - 3 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('projects.project_list', page=total_pages, per_page=per_page) }}">{{ total_pages }}</a>
                    </li>
                    {% endif %}
                    
                    <!-- 下一页 -->
                    <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                        <a class="page-link" href="{% if page < total_pages %}{{ url_for('projects.project_list', page=page+1, per_page=per_page) }}{% else %}#{% endif %}" aria-label="下一页">
                            下一页 <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <!-- 每页显示数量选择 -->
            <div class="text-center">
                <div class="btn-group btn-group-sm" role="group" aria-label="每页显示数量">
                    <span class="btn btn-sm btn-outline-secondary disabled">每页显示：</span>
                    <a href="{{ url_for('projects.project_list', page=1, per_page=10) }}" 
                       class="btn btn-sm btn-outline-primary {% if per_page == 10 %}active{% endif %}">10</a>
                    <a href="{{ url_for('projects.project_list', page=1, per_page=20) }}" 
                       class="btn btn-sm btn-outline-primary {% if per_page == 20 %}active{% endif %}">20</a>
                    <a href="{{ url_for('projects.project_list', page=1, per_page=50) }}" 
                       class="btn btn-sm btn-outline-primary {% if per_page == 50 %}active{% endif %}">50</a>
                    <a href="{{ url_for('projects.project_list', page=1, per_page=100) }}" 
                       class="btn btn-sm btn-outline-primary {% if per_page == 100 %}active{% endif %}">100</a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Clickable table rows
    document.querySelectorAll('tr[data-href]').forEach(row => {
        row.addEventListener('click', function(event) {
            // Prevent link navigation when clicking on checkbox itself
            if (event.target.type !== 'checkbox') {
                const targetUrl = this.dataset.href;
                
                // 通知父窗口显示加载遮罩（避免直接跳转导致导航栏消失）
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'showLoading',
                        url: targetUrl
                    }, '*');
                } else {
                    window.location = targetUrl;
                }
            }
        });
    });

    // 筛选功能
    const filterType = document.getElementById('filter-type');
    const filterFormulator = document.getElementById('filter-formulator');
    const filterDateStart = document.getElementById('filter-date-start');
    const filterDateEnd = document.getElementById('filter-date-end');
    const applyFilterBtn = document.getElementById('apply-filter');
    const resetFilterBtn = document.getElementById('reset-filter');
    const filterCount = document.getElementById('filter-count');
    
    // 去重并填充下拉选项
    function populateFilterOptions() {
        const types = new Set();
        const formulators = new Set();
        
        document.querySelectorAll('.project-row').forEach(row => {
            const type = row.dataset.type;
            const formulator = row.dataset.formulator;
            if (type) types.add(type);
            if (formulator) formulators.add(formulator);
        });
        
        // 清空并重新填充类型选项
        filterType.innerHTML = '<option value="">全部类型</option>';
        Array.from(types).sort().forEach(type => {
            filterType.innerHTML += `<option value="${type}">${type}</option>`;
        });
        
        // 清空并重新填充设计师选项
        filterFormulator.innerHTML = '<option value="">全部设计师</option>';
        Array.from(formulators).sort().forEach(formulator => {
            filterFormulator.innerHTML += `<option value="${formulator}">${formulator}</option>`;
        });
    }
    
    populateFilterOptions();
    
    // 应用筛选
    function applyFilter() {
        const typeValue = filterType.value.toLowerCase();
        const formulatorValue = filterFormulator.value.toLowerCase();
        const dateStart = filterDateStart.value;
        const dateEnd = filterDateEnd.value;
        
        let visibleCount = 0;
        let totalCount = 0;
        
        document.querySelectorAll('.project-row').forEach((row, index) => {
            totalCount++;
            const rowType = (row.dataset.type || '').toLowerCase();
            const rowFormulator = (row.dataset.formulator || '').toLowerCase();
            const rowDate = row.dataset.date;
            
            let show = true;
            
            // 类型筛选
            if (typeValue && rowType !== typeValue) {
                show = false;
            }
            
            // 设计师筛选
            if (formulatorValue && rowFormulator !== formulatorValue) {
                show = false;
            }
            
            // 日期筛选
            if (dateStart && rowDate < dateStart) {
                show = false;
            }
            if (dateEnd && rowDate > dateEnd) {
                show = false;
            }
            
            // 显示或隐藏行（包括其对应的详情行）
            if (show) {
                row.style.display = '';
                const detailsRow = row.nextElementSibling;
                if (detailsRow && detailsRow.classList.contains('details-row')) {
                    // 只有当详情行本来就显示时才保持显示
                    // 否则保持隐藏
                }
                visibleCount++;
            } else {
                row.style.display = 'none';
                const detailsRow = row.nextElementSibling;
                if (detailsRow && detailsRow.classList.contains('details-row')) {
                    detailsRow.style.display = 'none';
                }
            }
        });
        
        // 更新筛选计数
        if (visibleCount < totalCount) {
            filterCount.textContent = `显示 ${visibleCount} / ${totalCount} 条记录`;
        } else {
            filterCount.textContent = '';
        }
    }
    
    // 重置筛选
    function resetFilter() {
        filterType.value = '';
        filterFormulator.value = '';
        filterDateStart.value = '';
        filterDateEnd.value = '';
        
        document.querySelectorAll('.project-row').forEach(row => {
            row.style.display = '';
        });
        
        filterCount.textContent = '';
        
        // 更新全选框状态
        updateSelectAllState();
    }
    
    // 绑定事件
    applyFilterBtn.addEventListener('click', applyFilter);
    resetFilterBtn.addEventListener('click', resetFilter);
    
    // 按回车键应用筛选
    [filterType, filterFormulator, filterDateStart, filterDateEnd].forEach(element => {
        element.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                applyFilter();
            }
        });
    });

    // Select all checkbox functionality (仅选中可见的行)
    const selectAllCheckbox = document.getElementById('select-all');
    
    // 全选功能：只选中可见的行
    selectAllCheckbox.addEventListener('change', function() {
        const visibleCheckboxes = Array.from(document.querySelectorAll('.row-checkbox'))
            .filter(cb => {
                const row = cb.closest('.project-row');
                return row && row.style.display !== 'none';
            });
        
            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    
    // 在应用筛选后，取消隐藏行的选中状态，并更新全选框状态
    const originalApplyFilter = applyFilter;
    applyFilter = function() {
        originalApplyFilter();
        
        // 取消隐藏行的选中状态
        document.querySelectorAll('.project-row').forEach(row => {
            if (row.style.display === 'none') {
                const checkbox = row.querySelector('.row-checkbox');
                if (checkbox) {
                    checkbox.checked = false;
                }
            }
        });
        
        // 更新全选框状态
        updateSelectAllState();
    };
    
    // 更新全选框的状态（如果所有可见行都被选中，则全选框也被选中）
    function updateSelectAllState() {
        const visibleCheckboxes = Array.from(document.querySelectorAll('.row-checkbox'))
            .filter(cb => {
                const row = cb.closest('.project-row');
                return row && row.style.display !== 'none';
            });
        
        if (visibleCheckboxes.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else {
            const checkedCount = visibleCheckboxes.filter(cb => cb.checked).length;
            selectAllCheckbox.checked = checkedCount === visibleCheckboxes.length;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < visibleCheckboxes.length;
        }
    }
    
    // 监听每个复选框的变化，以更新全选框的状态
    document.querySelectorAll('.row-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectAllState);
    });
    
    // 表单提交验证：确保至少选中了一个项目
    const controlForm = document.getElementById('control-form');
    const exportBtn = document.getElementById('export-csv-btn');
    const deleteBtn = document.getElementById('delete-selected-btn');
    
    function getSelectedCount() {
        return document.querySelectorAll('.row-checkbox:checked').length;
    }
    
    exportBtn.addEventListener('click', function(e) {
        const selectedCount = getSelectedCount();
        if (selectedCount === 0) {
            e.preventDefault();
            alert('请至少选择一个项目进行导出！');
            return false;
        }
    });
    
    deleteBtn.addEventListener('click', function(e) {
        const selectedCount = getSelectedCount();
        if (selectedCount === 0) {
            e.preventDefault();
            alert('请至少选择一个项目进行删除！');
            return false;
        }
        
        if (!confirm(`您确定要删除选中的 ${selectedCount} 个项目吗？此操作不可撤销。`)) {
            e.preventDefault();
            return false;
        }
    });

    // --- 新建项目按钮过渡动画 ---
    const addProjectBtn = document.querySelector('a.btn.btn-primary');
    if (addProjectBtn) {
        addProjectBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const targetUrl = this.href;
            
                // 通知父窗口显示加载遮罩
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'showLoading',
                        url: targetUrl
                    }, '*');
                } else {
                    // 立即跳转，无延迟
                    window.location = targetUrl;
                }
        });
    }

    // --- 编辑按钮过渡动画 ---
    document.querySelectorAll('.btn-outline-primary').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const targetUrl = this.href;
            
            // 通知父窗口显示加载遮罩（与导航栏切换相同的效果）
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'showLoading',
                    url: targetUrl
                }, '*');
            } else {
                // 立即跳转，无延迟
                window.location.href = targetUrl;
            }
        });
    });

    // --- New Details toggle logic ---
    document.querySelectorAll('.btn-details').forEach(button => {
        button.addEventListener('click', async function(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const projectRow = this.closest('tr.project-row');
            const projectId = projectRow.dataset.projectId;
            const detailsRow = projectRow.nextElementSibling;
            const detailsContent = detailsRow.querySelector('.details-content');

            // If it's already open, close it
            if (detailsRow.style.display !== 'none') {
                detailsRow.style.display = 'none';
                this.textContent = '详情';
                return;
            }

            // Close any other open rows
            document.querySelectorAll('.details-row').forEach(row => row.style.display = 'none');
            document.querySelectorAll('.btn-details').forEach(btn => btn.textContent = '详情');
            
            // Show loading and fetch data
            detailsContent.innerHTML = '<p class="text-center">正在加载...</p>';
            detailsRow.style.display = 'table-row';
            this.textContent = '收起';

            try {
                const response = await fetch(`{{ url_for('projects.get_project_details', project_id=0) }}`.replace('0', projectId));
                const data = await response.json();

                if (data.success) {
                    const { info, composition, test_results } = data;
                    
                    let compositionHtml = '<p>无配方数据。</p>';
                    if (composition && composition.length > 0) {
                        compositionHtml = `
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>成分名称</th>
                                        <th>类型</th>
                                        <th>重量百分比 (%)</th>
                                        <th>掺入方法</th>
                                        <th>备注</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${composition.map(item => `
                                        <tr>
                                            <td>${item.MaterialName || item.FillerName || 'N/A'}</td>
                                            <td>${item.MaterialName ? '原料' : '无机材料'}</td>
                                            <td>${parseFloat(item.WeightPercentage).toFixed(4)}</td>
                                            <td>${item.AdditionMethod || ''}</td>
                                            <td>${item.Remarks || ''}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    }

                    let testResultsHtml = '<p>无测试结果。</p>';
                    if (test_results && Object.keys(test_results).length > 0) {
                        // 定义不同项目类型的字段映射
                        const fieldMappings = {
                            '喷墨': {
                                'Ink_Viscosity': '粘度',
                                'Ink_Reactivity': '反应活性/固化时间',
                                'Ink_ParticleSize': '粒径(nm)',
                                'Ink_SurfaceTension': '表面张力(mN/m)',
                                'Ink_ColorValue': '色度(Lab*色值)',
                                'Ink_RheologyNote': '流变学说明'
                            },
                            '涂层': {
                                'Coating_Adhesion': '附着力',
                                'Coating_Transparency': '透明度',
                                'Coating_SurfaceHardness': '表面硬度',
                                'Coating_ChemicalResistance': '耐化学性',
                                'Coating_CostEstimate': '成本估算(€/kg)'
                            },
                            '3D打印': {
                                'Print3D_Shrinkage': '收缩率(%)',
                                'Print3D_YoungsModulus': '杨氏模量',
                                'Print3D_FlexuralStrength': '弯曲强度',
                                'Print3D_ShoreHardness': '邵氏硬度',
                                'Print3D_ImpactResistance': '抗冲击性'
                            },
                            '复合材料': {
                                'Composite_FlexuralStrength': '弯曲强度',
                                'Composite_YoungsModulus': '杨氏模量',
                                'Composite_ImpactResistance': '抗冲击性',
                                'Composite_ConversionRate': '转化率',
                                'Composite_WaterAbsorption': '吸水率/溶解度'
                            }
                        };
                        
                        // 获取项目类型
                        const projectType = info.TypeName;
                        const relevantFields = fieldMappings[projectType] || {};
                        
                        // 构建测试结果列表
                        let items = [];
                        for (const [fieldKey, displayName] of Object.entries(relevantFields)) {
                            const value = test_results[fieldKey];
                            if (value !== null && value !== undefined && value !== '') {
                                items.push(`<li class="list-group-item"><strong>${displayName}:</strong> ${value}</li>`);
                            }
                        }
                        
                        // 添加通用字段
                        if (test_results.TestDate) {
                            items.push(`<li class="list-group-item"><strong>测试日期:</strong> ${test_results.TestDate}</li>`);
                        }
                        if (test_results.Notes) {
                            items.push(`<li class="list-group-item"><strong>备注:</strong> ${test_results.Notes}</li>`);
                        }
                        
                        if (items.length > 0) {
                            testResultsHtml = `<ul class="list-group list-group-flush">${items.join('')}</ul>`;
                        }
                    }
                    
                    detailsContent.innerHTML = `
                        <div class="p-3">
                            <h5>配方成分</h5>
                            ${compositionHtml}
                            <h5 class="mt-4">测试结果摘要</h5>
                            ${testResultsHtml}
                            <a href="${this.previousElementSibling.href}" class="btn btn-secondary btn-sm mt-3">查看完整信息并编辑</a>
                        </div>
                    `;

                } else {
                    detailsContent.innerHTML = `<div class="p-3 text-danger">加载数据时发生错误: ${data.message || '未知错误'}</div>`;
                }
            } catch (error) {
                console.error('Failed to fetch details:', error);
                detailsContent.innerHTML = '<p class="text-danger">加载数据时发生错误。</p>';
            }
        });
    });
});
</script>
{% endblock %}
