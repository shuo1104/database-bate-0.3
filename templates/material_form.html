{% extends "layout_embedded.html" %}

{% block title %}
{% if action == 'add' %}新建原料{% else %}编辑原料{% endif %}
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>{{ '编辑原料' if action == 'edit' else '创建新原料' }}</h2>
    <form method="POST" action="{{ url_for('materials.edit_material', material_id=material.MaterialID) if action == 'edit' else url_for('materials.add_material') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="row g-3">
            <div class="col-md-6">
                <label for="TradeName" class="form-label">商品名称 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="TradeName" name="TradeName" value="{{ material.TradeName or '' }}" required>
            </div>
            <div class="col-md-6">
                <label for="Category_FK" class="form-label">类别</label>
                <select class="form-select" id="Category_FK" name="Category_FK">
                    <option value="">请选择...</option>
                    {% for category in categories %}
                    <option value="{{ category.CategoryID }}" {% if material.Category_FK == category.CategoryID %}selected{% endif %}>
                        {{ category.CategoryName }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="Supplier" class="form-label">供应商</label>
                <input type="text" class="form-control" id="Supplier" name="Supplier" value="{{ material.Supplier or '' }}">
            </div>
            <div class="col-md-6">
                <label for="CAS_Number" class="form-label">化学文摘登记号 (CAS 号)</label>
                <input type="text" class="form-control" id="CAS_Number" name="CAS_Number" value="{{ material.CAS_Number or '' }}">
            </div>
            <div class="col-md-6">
                <label for="Density" class="form-label">密度</label>
                <input type="number" step="0.0001" class="form-control" id="Density" name="Density" value="{{ material.Density or '' }}">
            </div>
            <div class="col-md-6">
                <label for="Viscosity" class="form-label">粘度</label>
                <input type="number" step="0.0001" class="form-control" id="Viscosity" name="Viscosity" value="{{ material.Viscosity or '' }}">
            </div>
            <div class="col-12">
                <label for="FunctionDescription" class="form-label">功能说明</label>
                <textarea class="form-control" id="FunctionDescription" name="FunctionDescription" rows="3">{{ material.FunctionDescription or '' }}</textarea>
            </div>
        </div>

        <hr class="my-4">

        <div class="mt-3">
            <a href="{{ url_for('materials.material_list') }}" class="btn btn-secondary">返回列表</a>
            <button type="submit" class="btn btn-primary">{{ '更新' if action == 'edit' else '创建' }}</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// 为所有导航和操作按钮添加过渡动画
document.addEventListener('DOMContentLoaded', function() {
    // 为"返回列表"按钮添加过渡动画
    const backButton = document.querySelector('a.btn.btn-secondary');
    if (backButton) {
        backButton.addEventListener('click', function(e) {
            e.preventDefault();
            const targetUrl = this.href;
            
            // 通知父窗口显示加载遮罩
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'showLoading',
                    url: targetUrl
                }, '*');
            } else {
                window.location.href = targetUrl;
            }
        });
    }
    
    // 为表单提交添加过渡动画
    const form = document.querySelector('form[method="POST"]');
    if (form) {
        form.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>保存中...';
                
                // 如果表单验证失败，恢复按钮状态
                setTimeout(function() {
                    if (!form.checkValidity()) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                }, 100);
            }
        });
    }
});
</script>
{% endblock %}
