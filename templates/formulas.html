{% extends "layout_embedded.html" %}

{% block title %}
查看配方成分
{% endblock %}

{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-body">
        <div class="mb-4">
            <label for="project-selector" class="form-label h5">
                <i class="bi bi-search"></i> 选择项目以查看配方：
            </label>
            <select id="project-selector" class="form-select form-select-lg">
                <option selected disabled>--- 点击选择项目 ---</option>
                {% for project in projects %}
                <option value="{{ project.ProjectID }}">
                    #{{ project.ProjectID }} - {{ project.ProjectName }} ({{ project.FormulaCode or 'N/A' }})
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

<div id="composition-display" class="mt-4" style="display: none;">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 id="composition-header" class="mb-0"></h3>
            <a href="#" id="edit-project-link" class="btn btn-primary">进入编辑模式</a>
        </div>
        <div class="card-body" id="composition-content">
            <!-- Composition details will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selector = document.getElementById('project-selector');
    const displayDiv = document.getElementById('composition-display');
    const contentDiv = document.getElementById('composition-content');
    const headerEl = document.getElementById('composition-header');
    const editLink = document.getElementById('edit-project-link');
    
    // 为编辑按钮添加过渡动画（与导航栏切换相同的加载遮罩效果）
    editLink.addEventListener('click', function(e) {
        e.preventDefault();
        const targetUrl = this.href;
        
        // 通知父窗口显示加载遮罩
        if (window.parent && window.parent !== window) {
            window.parent.postMessage({
                type: 'showLoading',
                url: targetUrl
            }, '*');
        } else {
            // 如果不在 iframe 中，使用原来的淡出效果
            // 立即跳转，无延迟
            window.location.href = targetUrl;
        }
    });

    selector.addEventListener('change', async function() {
        const projectId = this.value;
        if (!projectId) return;

        // Show loading state
        displayDiv.style.display = 'block';
        contentDiv.innerHTML = '<p class="text-center">正在加载...</p>';
        headerEl.textContent = `项目 #${projectId} 的配方`;
        editLink.href = `{{ url_for('formulas.edit_formula', project_id=0) }}`.replace('0', projectId);

        try {
            const url = `{{ url_for('projects.get_project_details', project_id=0) }}`.replace('0', projectId);
            console.log('请求URL:', url);
            
            const response = await fetch(url);
            console.log('响应状态:', response.status);
            
            const data = await response.json();
            console.log('响应数据:', data);

            if (data.success) {
                contentDiv.innerHTML = formatCompositionDetails(data.composition);
            } else {
                contentDiv.innerHTML = `<p class="text-danger">加载失败: ${data.message || '未知错误'}</p>`;
            }
        } catch (error) {
            console.error('获取详情失败:', error);
            console.error('错误堆栈:', error.stack);
            contentDiv.innerHTML = `<p class="text-danger">加载数据时发生错误: ${error.message}</p>`;
        }
    });

    function formatCompositionDetails(composition) {
        try {
            if (!composition || composition.length === 0) {
                return '<p>此项目尚无配方成分记录。</p>';
            }

            let tableHtml = `
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>成分名称</th>
                            <th>类型</th>
                            <th>重量百分比 (%)</th>
                            <th>掺入方法</th>
                            <th>备注</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
        
        let totalWeight = 0;
        composition.forEach(item => {
            const name = item.MaterialName || item.FillerName;
            const type = item.MaterialName ? '原料' : '无机材料';
            const weight = parseFloat(item.WeightPercentage) || 0;
            totalWeight += weight;
            tableHtml += `
                <tr>
                    <td>${name}</td>
                    <td>${type}</td>
                    <td>${weight.toFixed(4)}</td>
                    <td>${item.AdditionMethod || ''}</td>
                    <td>${item.Remarks || ''}</td>
                </tr>
            `;
        });

        tableHtml += `
                </tbody>
                <tfoot>
                    <tr class="table-light">
                        <td colspan="2" class="text-end"><strong>总计:</strong></td>
                        <td><strong>${totalWeight.toFixed(4)}</strong></td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
        `;
        return tableHtml;
        } catch (error) {
            console.error('格式化配方详情时出错:', error);
            return `<p class="text-danger">格式化数据时发生错误: ${error.message}</p>`;
        }
    }
});
</script>
{% endblock %}
