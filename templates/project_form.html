{% extends "layout_embedded.html" %}

{% block title %}
{% if action == 'add' %}
新建项目
{% else %}
编辑项目 - {{ project.ProjectName }}
{% endif %}
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="mb-0">
            {% if action == 'add' %}
            新建项目基本信息
            {% else %}
            <a class="text-decoration-none" data-bs-toggle="collapse" href="#project-info-collapse" role="button" aria-expanded="true" aria-controls="project-info-collapse">
                编辑项目 ID: {{ project.ProjectID }} (点击展开/折叠基本信息)
            </a>
            {% endif %}
        </h2>
        <div>
            {% if action == 'edit' %}
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                删除
            </button>
            {% endif %}
            <a href="{{ url_for('projects.project_list') }}" class="btn btn-secondary">返回列表</a>
        </div>
    </div>
    <div class="collapse {% if focus != 'composition' %}show{% endif %}" id="project-info-collapse">
        <div class="card-body">
            <form method="POST" action="{{ url_for('projects.edit_project', project_id=project.ProjectID) if action == 'edit' else url_for('projects.add_project') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="ProjectName" class="form-label">项目名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="ProjectName" name="ProjectName" value="{{ project.ProjectName or '' }}" required>
                    </div>

                    <div class="col-md-6">
                        <label for="ProjectType_FK" class="form-label">项目类型 <span class="text-danger">*</span></label>
                        {% if action == 'edit' %}
                        <input type="text" class="form-control" value="{{ project.TypeName }}" readonly disabled>
                        <input type="hidden" name="ProjectType_FK" value="{{ project.ProjectType_FK }}">
                        <div class="form-text">项目类型在创建后不可更改。</div>
                        {% else %}
                        <select class="form-select" id="ProjectType_FK" name="ProjectType_FK" required>
                            <option value="">请选择...</option>
                            {% for type in project_types %}
                            <option value="{{ type.TypeID }}" {% if project.ProjectType_FK == type.TypeID %}selected{% endif %}>
                                {{ type.TypeName }}
                            </option>
                            {% endfor %}
                        </select>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        <label for="FormulatorName" class="form-label">配方设计师姓名 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="FormulatorName" name="FormulatorName" value="{{ project.FormulatorName or '' }}" required>
                    </div>

                    <div class="col-md-6">
                        <label for="FormulationDate" class="form-label">配方设计日期 <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="FormulationDate" name="FormulationDate" value="{{ project.FormulationDate.strftime('%Y-%m-%d') if project.FormulationDate else '' }}" required>
                    </div>

                    <div class="col-12">
                        <label for="SubstrateApplication" class="form-label">目标基材或应用领域</label>
                        <textarea class="form-control" id="SubstrateApplication" name="SubstrateApplication" rows="3">{{ project.SubstrateApplication or '' }}</textarea>
                    </div>
                    
                    {% if action == 'edit' and project.FormulaCode %}
                    <div class="col-12">
                        <label for="FormulaCode" class="form-label">自动生成的配方编码</label>
                        <input type="text" class="form-control" id="FormulaCode" name="FormulaCode" value="{{ project.FormulaCode }}" readonly disabled>
                        <div class="form-text">配方编码在创建后不可更改。</div>
                    </div>
                    {% endif %}
                </div>

                <hr class="my-4">

                <button class="w-100 btn btn-primary btn-lg" type="submit">
                    {% if action == 'add' %}
                    创建项目
                    {% else %}
                    保存更改
                    {% endif %}
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Composition Management Section (only for existing projects) -->
{% if action == 'edit' %}
<div class="card mt-4" id="composition-section">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="mb-0">配方成分表</h2>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addComponentModal">
            添加成分
        </button>
    </div>
    <div class="card-body">
        <table class="table" id="composition-table">
            <thead>
                <tr>
                    <th>成分名称</th>
                    <th>类型</th>
                    <th>重量百分比 (%)</th>
                    <th>掺入方法</th>
                    <th>备注</th>
                    <th style="width: 10%;">操作</th>
                </tr>
            </thead>
            <tbody>
                {% set total_weight = namespace(value=0) %}
                {% for item in composition %}
                <tr id="comp-row-{{ item.CompositionID }}">
                    <td>{{ item.MaterialName or item.FillerName }}</td>
                    <td>{% if item.MaterialName %}原料{% else %}无机材料{% endif %}</td>
                    <td>{{ "%.4f"|format(item.WeightPercentage) }}</td>
                    <td>{{ item.AdditionMethod or '' }}</td>
                    <td>{{ item.Remarks or '' }}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteComponent({{ item.CompositionID }})">删除</button>
                    </td>
                </tr>
                {% set total_weight.value = total_weight.value + item.WeightPercentage %}
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="table-light">
                    <td colspan="2" class="text-end"><strong>总计:</strong></td>
                    <td id="total-weight"><strong>{{ "%.4f"|format(total_weight.value) }}</strong></td>
                    <td colspan="2"></td>
                </tr>
            </tfoot>
        </table>
        <div id="weight-validation-alert" class="alert d-none" role="alert"></div>
    </div>
</div>

<!-- Add Component Modal -->
<div class="modal fade" id="addComponentModal" tabindex="-1" aria-labelledby="addComponentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addComponentModalLabel">添加新成分</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="add-component-form">
            <input type="hidden" id="modal_project_id" name="project_id" value="{{ project.ProjectID }}">
            <div class="mb-3">
                <label for="modal_component_type" class="form-label">成分类型</label>
                <select class="form-select" id="modal_component_type" name="component_type">
                    <option value="material">原料</option>
                    <option value="filler">无机材料</option>
                </select>
            </div>
            <div class="mb-3" id="material-select-div">
                <label for="modal_material_id" class="form-label">选择原料</label>
                <select class="form-select" id="modal_material_id" name="component_id">
                    {% for mat in all_materials %}<option value="{{ mat.MaterialID }}">{{ mat.TradeName }}</option>{% endfor %}
                </select>
            </div>
            <div class="mb-3 d-none" id="filler-select-div">
                <label for="modal_filler_id" class="form-label">选择无机材料</label>
                <select class="form-select" id="modal_filler_id" name="component_id">
                    {% for fil in all_fillers %}<option value="{{ fil.FillerID }}">{{ fil.TradeName }}</option>{% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="modal_weight" class="form-label">重量百分比 (%)</label>
                <input type="number" step="0.0001" class="form-control" id="modal_weight" name="weight" required>
            </div>
            <div class="mb-3">
                <label for="modal_addition_method" class="form-label">掺入方法</label>
                <input type="text" class="form-control" id="modal_addition_method" name="addition_method">
            </div>
            <div class="mb-3">
                <label for="modal_remarks" class="form-label">备注</label>
                <textarea class="form-control" id="modal_remarks" name="remarks" rows="2"></textarea>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="addComponent()">确认添加</button>
      </div>
    </div>
  </div>
</div>

<!-- Test Results Section -->
<div class="card mt-4" id="test-results-section">
    <div class="card-header">
        <h2 class="mb-0">
             <a class="text-decoration-none" data-bs-toggle="collapse" href="#test-results-collapse" role="button" aria-expanded="true" aria-controls="test-results-collapse">
                测试结果数据表 (点击展开/折叠)
            </a>
        </h2>
    </div>
    <div class="collapse {% if focus != 'composition' %}show{% endif %}" id="test-results-collapse">
        <div class="card-body">
            <p class="text-muted">此区域显示的字段取决于上方设置的"项目类型"。</p>
            <form action="{{ url_for('projects.save_test_results', project_id=project.ProjectID) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="row g-3">
                    <!-- 喷墨墨水指标 -->
                    {% if project.TypeName == '喷墨' %}
                    <div class="col-12"><h5 class="text-primary">喷墨墨水测试指标</h5></div>
                    <div class="col-md-6">
                        <label for="Ink_Viscosity" class="form-label">粘度</label>
                        <input type="text" class="form-control" id="Ink_Viscosity" name="Ink_Viscosity" value="{{ test_results.get('Ink_Viscosity') or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="Ink_Reactivity" class="form-label">反应活性 / 固化时间</label>
                        <input type="text" class="form-control" id="Ink_Reactivity" name="Ink_Reactivity" value="{{ test_results.get('Ink_Reactivity') or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="Ink_ParticleSize" class="form-label">粒径 (nm)</label>
                        <input type="text" class="form-control" id="Ink_ParticleSize" name="Ink_ParticleSize" value="{{ test_results.get('Ink_ParticleSize') or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="Ink_SurfaceTension" class="form-label">表面张力 (mN/m)</label>
                        <input type="text" class="form-control" id="Ink_SurfaceTension" name="Ink_SurfaceTension" value="{{ test_results.get('Ink_SurfaceTension') or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="Ink_ColorValue" class="form-label">色度 (Lab* 色值)</label>
                        <input type="text" class="form-control" id="Ink_ColorValue" name="Ink_ColorValue" value="{{ test_results.get('Ink_ColorValue') or '' }}" placeholder="例: L*=50, a*=10, b*=-5">
                    </div>
                    <div class="col-md-12">
                        <label for="Ink_RheologyNote" class="form-label">流变学说明或文件</label>
                        <textarea class="form-control" id="Ink_RheologyNote" name="Ink_RheologyNote" rows="3">{{ test_results.get('Ink_RheologyNote') or '' }}</textarea>
                    </div>
                    {% endif %}

                    <!-- 涂层指标 -->
                    {% if project.TypeName == '涂层' %}
                    <div class="col-12"><h5 class="text-primary">涂层测试指标</h5></div>
                    <div class="col-md-6">
                        <label for="Coating_Adhesion" class="form-label">附着力</label>
                        <input type="text" class="form-control" id="Coating_Adhesion" name="Coating_Adhesion" value="{{ test_results.get('Coating_Adhesion') or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="Coating_Transparency" class="form-label">透明度</label>
                        <input type="text" class="form-control" id="Coating_Transparency" name="Coating_Transparency" value="{{ test_results.get('Coating_Transparency') or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="Coating_SurfaceHardness" class="form-label">表面硬度</label>
                        <input type="text" class="form-control" id="Coating_SurfaceHardness" name="Coating_SurfaceHardness" value="{{ test_results.get('Coating_SurfaceHardness') or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="Coating_ChemicalResistance" class="form-label">耐化学性</label>
                        <input type="text" class="form-control" id="Coating_ChemicalResistance" name="Coating_ChemicalResistance" value="{{ test_results.get('Coating_ChemicalResistance') or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="Coating_CostEstimate" class="form-label">成本估算 (€/kg)</label>
                        <input type="text" class="form-control" id="Coating_CostEstimate" name="Coating_CostEstimate" value="{{ test_results.get('Coating_CostEstimate') or '' }}">
                    </div>
                    {% endif %}
                    
                    <!-- 3D打印指标 -->
                    {% if project.TypeName == '3D打印' %}
                    <div class="col-12"><h5 class="text-primary">3D打印测试指标</h5></div>
                    <div class="col-md-6">
                        <label for="Print3D_Shrinkage" class="form-label">收缩率 (%)</label>
                        <input type="text" class="form-control" id="Print3D_Shrinkage" name="Print3D_Shrinkage" value="{{ test_results.get('Print3D_Shrinkage') or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="Print3D_YoungsModulus" class="form-label">杨氏模量</label>
                        <input type="text" class="form-control" id="Print3D_YoungsModulus" name="Print3D_YoungsModulus" value="{{ test_results.get('Print3D_YoungsModulus') or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="Print3D_FlexuralStrength" class="form-label">弯曲强度</label>
                        <input type="text" class="form-control" id="Print3D_FlexuralStrength" name="Print3D_FlexuralStrength" value="{{ test_results.get('Print3D_FlexuralStrength') or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="Print3D_ShoreHardness" class="form-label">邵氏硬度</label>
                        <input type="text" class="form-control" id="Print3D_ShoreHardness" name="Print3D_ShoreHardness" value="{{ test_results.get('Print3D_ShoreHardness') or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="Print3D_ImpactResistance" class="form-label">抗冲击性</label>
                        <input type="text" class="form-control" id="Print3D_ImpactResistance" name="Print3D_ImpactResistance" value="{{ test_results.get('Print3D_ImpactResistance') or '' }}">
                    </div>
                    {% endif %}

                    <!-- 复合材料指标 -->
                    {% if project.TypeName == '复合材料' %}
                    <div class="col-12"><h5 class="text-primary">复合材料测试指标</h5></div>
                    <div class="col-md-6">
                        <label for="Composite_FlexuralStrength" class="form-label">弯曲强度</label>
                        <input type="text" class="form-control" id="Composite_FlexuralStrength" name="Composite_FlexuralStrength" value="{{ test_results.get('Composite_FlexuralStrength') or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="Composite_YoungsModulus" class="form-label">杨氏模量</label>
                        <input type="text" class="form-control" id="Composite_YoungsModulus" name="Composite_YoungsModulus" value="{{ test_results.get('Composite_YoungsModulus') or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="Composite_ImpactResistance" class="form-label">抗冲击性</label>
                        <input type="text" class="form-control" id="Composite_ImpactResistance" name="Composite_ImpactResistance" value="{{ test_results.get('Composite_ImpactResistance') or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="Composite_ConversionRate" class="form-label">转化率 (可选)</label>
                        <input type="text" class="form-control" id="Composite_ConversionRate" name="Composite_ConversionRate" value="{{ test_results.get('Composite_ConversionRate') or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="Composite_WaterAbsorption" class="form-label">吸水率 / 溶解度 (可选)</label>
                        <input type="text" class="form-control" id="Composite_WaterAbsorption" name="Composite_WaterAbsorption" value="{{ test_results.get('Composite_WaterAbsorption') or '' }}">
                    </div>
                    {% endif %}
                    
                    <!-- 通用字段 -->
                    <div class="col-12"><hr class="my-3"></div>
                    <div class="col-md-6">
                        <label for="TestDate" class="form-label">测试日期</label>
                        <input type="date" class="form-control" id="TestDate" name="TestDate" value="{{ test_results.get('TestDate') or '' }}">
                    </div>
                    <div class="col-md-12">
                        <label for="Notes" class="form-label">备注</label>
                        <textarea class="form-control" id="Notes" name="Notes" rows="3">{{ test_results.get('Notes') or '' }}</textarea>
                    </div>
                </div>
                
                <hr class="my-4">
                <button class="w-100 btn btn-info" type="submit">保存测试结果</button>
            </form>
        </div>
    </div>
</div>
{% endif %}
<!-- Delete Confirmation Modal -->
{% if action == 'edit' %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">确认删除</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        您确定要永久删除项目 “{{ project.ProjectName }}” 吗？此操作不可撤销。
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <form action="{{ url_for('projects.batch_action') }}" method="POST" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <input type="hidden" id="delete-action-input" name="action" value="delete">
            <input type="hidden" id="delete-id-input" name="selected_ids" value="{{ project.ProjectID }}">
            <button type="submit" class="btn btn-danger">确认删除</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if action == 'edit' %}
<script>
// Toggle between material and filler dropdowns in the modal
document.getElementById('modal_component_type').addEventListener('change', function() {
    const materialDiv = document.getElementById('material-select-div');
    const fillerDiv = document.getElementById('filler-select-div');
    const materialSelect = document.getElementById('modal_material_id');
    const fillerSelect = document.getElementById('modal_filler_id');
    
    if (this.value === 'material') {
        materialDiv.classList.remove('d-none');
        fillerDiv.classList.add('d-none');
        materialSelect.disabled = false;
        fillerSelect.disabled = true;
    } else {
        materialDiv.classList.add('d-none');
        fillerDiv.classList.remove('d-none');
        materialSelect.disabled = true;
        fillerSelect.disabled = false;
    }
});

function updateTotalWeight(change) {
    const totalWeightEl = document.getElementById('total-weight').querySelector('strong');
    let currentTotal = parseFloat(totalWeightEl.textContent);
    let newTotal = currentTotal + change;
    totalWeightEl.textContent = newTotal.toFixed(4);
    validateTotalWeight(newTotal);
}

function validateTotalWeight(total) {
    const alertEl = document.getElementById('weight-validation-alert');
    if (total < 99.5 || total > 100.5) {
        alertEl.textContent = `警告：当前总重为 ${total.toFixed(4)}%，不在 100% ± 0.5% 的范围内。`;
        alertEl.className = 'alert alert-warning'; // Use 'd-none' to hide
    } else {
        alertEl.textContent = `当前总重为 ${total.toFixed(4)}%，符合要求。`;
        alertEl.className = 'alert alert-success';
    }
}

async function addComponent() {
    const form = document.getElementById('add-component-form');
    const formData = new FormData(form);
    
    // 获取成分类型
    const componentType = document.getElementById('modal_component_type').value;

    try {
        const response = await fetch("{{ url_for('projects.add_composition') }}", {
            method: 'POST',
            body: new URLSearchParams(formData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('添加成分响应:', result);

        if (result.success) {
            // Add new row to table
            const tableBody = document.getElementById('composition-table').querySelector('tbody');
            const componentTypeText = componentType === 'material' ? '原料' : '无机材料';
            const newRow = `
                <tr id="comp-row-${result.composition_id}">
                    <td>${result.component_name}</td>
                    <td>${componentTypeText}</td>
                    <td>${parseFloat(result.weight).toFixed(4)}</td>
                    <td>${result.addition_method || ''}</td>
                    <td>${result.remarks || ''}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteComponent(${result.composition_id})">删除</button></td>
                </tr>
            `;
            tableBody.insertAdjacentHTML('beforeend', newRow);

            // Update total weight
            updateTotalWeight(parseFloat(result.weight));
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addComponentModal'));
            modal.hide();
            form.reset();

        } else {
            alert('添加失败: ' + result.message);
        }
    } catch (error) {
        console.error('添加成分失败:', error);
        alert('添加成分时发生错误: ' + error.message);
    }
}

async function deleteComponent(compositionId) {
    if (!confirm('您确定要删除这个成分吗？')) return;

    try {
        const response = await fetch(`{{ url_for('projects.delete_composition', composition_id=0) }}`.replace('0', compositionId), {
            method: 'POST'
        });
        const result = await response.json();

        if (result.success) {
            const row = document.getElementById(`comp-row-${compositionId}`);
            const weightCell = row.children[2];
            const weightChange = -parseFloat(weightCell.textContent);
            
            row.remove();
            updateTotalWeight(weightChange);

        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Failed to delete component:', error);
        alert('An unexpected error occurred.');
    }
}

// Initial validation check on page load
document.addEventListener('DOMContentLoaded', function() {
    const totalWeightEl = document.getElementById('total-weight');
    if (totalWeightEl) {
        validateTotalWeight(parseFloat(totalWeightEl.textContent));
    }
});

</script>
{% endif %}

<script>
// 为所有导航和操作按钮添加过渡动画
document.addEventListener('DOMContentLoaded', function() {
    // 为"返回列表"按钮添加过渡动画
    const backButtons = document.querySelectorAll('a.btn.btn-secondary');
    backButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const targetUrl = this.href;
            
            // 通知父窗口显示加载遮罩
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'showLoading',
                    url: targetUrl
                }, '*');
            } else {
                window.location.href = targetUrl;
            }
        });
    });
    
    // 为表单提交添加过渡动画
    const forms = document.querySelectorAll('form[method="POST"]');
    forms.forEach(form => {
        // 跳过删除表单（它在模态框中）
        if (form.querySelector('#delete-id-input')) {
            return;
        }
        
        form.addEventListener('submit', function(e) {
            // 显示提交中的状态
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>保存中...';
                
                // 如果表单验证失败，恢复按钮状态
                setTimeout(function() {
                    if (!form.checkValidity()) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                }, 100);
            }
        });
    });
    
    // 为删除确认按钮添加过渡动画
    const deleteForm = document.querySelector('form[action*="batch_action"]');
    if (deleteForm) {
        deleteForm.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>删除中...';
            }
        });
    }
});
</script>
{% endblock %}
