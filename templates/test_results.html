{% extends "layout_embedded.html" %}

{% block title %}
查看测试结果
{% endblock %}

{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-body">
        <div class="mb-4">
            <label for="project-selector" class="form-label h5">
                <i class="bi bi-search"></i> 选择项目以查看测试结果：
            </label>
            <select id="project-selector" class="form-select form-select-lg">
                <option selected disabled>--- 点击选择项目 ---</option>
                {% for project in projects %}
                <option value="{{ project.ProjectID }}" data-type-name="{{ project.TypeName }}">
                    #{{ project.ProjectID }} - {{ project.ProjectName }} ({{ project.FormulaCode or 'N/A' }})
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

<div id="results-display" class="mt-4" style="display: none;">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
            <h3 id="results-header" class="mb-0"></h3>
            <a href="#" id="edit-project-link" class="btn btn-primary">
                <i class="bi bi-pencil"></i> 进入编辑模式
            </a>
        </div>
        <div class="card-body" id="results-content">
            <!-- Test results will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    const selector = document.getElementById('project-selector');
    const displayDiv = document.getElementById('results-display');
    const contentDiv = document.getElementById('results-content');
    const headerEl = document.getElementById('results-header');
    const editLink = document.getElementById('edit-project-link');
    
    // 为编辑按钮添加过渡动画（与导航栏切换相同的加载遮罩效果）
    editLink.addEventListener('click', function(e) {
        e.preventDefault();
        const targetUrl = this.href;
        
        // 通知父窗口显示加载遮罩
        if (window.parent && window.parent !== window) {
            window.parent.postMessage({
                type: 'showLoading',
                url: targetUrl
            }, '*');
        } else {
            // 如果不在 iframe 中，使用原来的淡出效果
            document.body.style.transition = 'opacity 0.3s ease-out';
            document.body.style.opacity = '0';
            setTimeout(function() {
                window.location.href = targetUrl;
            }, 300);
        }
    });

    selector.addEventListener('change', async function() {
        const projectId = this.value;
        if (!projectId) return;

        // 获取项目类型名称
        const selectedOption = this.options[this.selectedIndex];
        const projectTypeName = selectedOption.getAttribute('data-type-name');

        // 显示加载状态
        displayDiv.style.display = 'block';
        contentDiv.innerHTML = '<p class="text-center"><i class="spinner-border spinner-border-sm me-2"></i>正在加载...</p>';
        headerEl.textContent = `项目 #${projectId} 的测试结果`;
        editLink.href = `{{ url_for('projects.edit_test_results', project_id=0) }}`.replace('0', projectId);

        try {
            const url = `{{ url_for('projects.get_project_details', project_id=0) }}`.replace('0', projectId);
            console.log('请求URL:', url);
            
            const response = await fetch(url);
            console.log('响应状态:', response.status);
            
            const data = await response.json();
            console.log('响应数据:', data);

            if (data.success) {
                contentDiv.innerHTML = formatTestResults(data.test_results, projectTypeName, data.info);
            } else {
                contentDiv.innerHTML = `<p class="text-danger">加载失败: ${data.message || '未知错误'}</p>`;
            }
        } catch (error) {
            console.error('获取测试结果失败:', error);
            console.error('错误堆栈:', error.stack);
            contentDiv.innerHTML = `<p class="text-danger">加载数据时发生错误: ${error.message}</p>`;
        }
    });

    function formatTestResults(results, projectTypeName, projectInfo) {
        try {
            if (!results || Object.keys(results).length === 0) {
                return `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        此项目尚无测试结果记录。点击"进入编辑模式"添加测试结果。
                    </div>
                `;
            }

            // 定义字段映射和显示名称
            const fieldMappings = {
                '喷墨': {
                    'Ink_Viscosity': '粘度',
                    'Ink_Reactivity': '反应活性 / 固化时间',
                    'Ink_ParticleSize': '粒径 (nm)',
                    'Ink_SurfaceTension': '表面张力 (mN/m)',
                    'Ink_ColorValue': '色度 (Lab* 色值)',
                    'Ink_RheologyNote': '流变学说明或文件'
                },
                '涂层': {
                    'Coating_Adhesion': '附着力',
                    'Coating_Transparency': '透明度',
                    'Coating_SurfaceHardness': '表面硬度',
                    'Coating_ChemicalResistance': '耐化学性',
                    'Coating_CostEstimate': '成本估算 (€/kg)'
                },
                '3D打印': {
                    'Print3D_Shrinkage': '收缩率 (%)',
                    'Print3D_YoungsModulus': '杨氏模量',
                    'Print3D_FlexuralStrength': '弯曲强度',
                    'Print3D_ShoreHardness': '邵氏硬度',
                    'Print3D_ImpactResistance': '抗冲击性'
                },
                '复合材料': {
                    'Composite_FlexuralStrength': '弯曲强度',
                    'Composite_YoungsModulus': '杨氏模量',
                    'Composite_ImpactResistance': '抗冲击性',
                    'Composite_ConversionRate': '转化率 (可选)',
                    'Composite_WaterAbsorption': '吸水率 / 溶解度 (可选)'
                }
            };

            const relevantFields = fieldMappings[projectTypeName] || {};
            
            let html = '<div class="row g-3">';
            let hasContent = false;

            // 遍历相关字段
            for (const [fieldKey, displayName] of Object.entries(relevantFields)) {
                const value = results[fieldKey];
                
                if (value !== null && value !== undefined && value !== '') {
                    hasContent = true;
                    html += `
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="text-muted mb-1">${displayName}</h6>
                                    <p class="h5 mb-0">${value}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // 添加通用字段（测试日期和备注）
            if (results.TestDate) {
                hasContent = true;
                html += `
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <h6 class="text-muted mb-1">测试日期</h6>
                                <p class="h5 mb-0">${results.TestDate}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            if (results.Notes) {
                hasContent = true;
                html += `
                    <div class="col-md-12">
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <h6 class="text-muted mb-1">备注</h6>
                                <p class="mb-0">${results.Notes}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';

            if (!hasContent) {
                return `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        此 ${projectTypeName} 项目尚无测试结果记录。点击"进入编辑模式"添加测试结果。
                    </div>
                `;
            }

            // 添加项目基本信息
            const infoHtml = `
                <div class="mb-4">
                    <h5 class="mb-3"><i class="bi bi-info-circle me-2"></i>项目信息</h5>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <small class="text-muted">项目名称：</small>
                            <strong>${projectInfo.ProjectName || 'N/A'}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">项目类型：</small>
                            <strong>${projectTypeName || 'N/A'}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">配方编码：</small>
                            <strong>${projectInfo.FormulaCode || 'N/A'}</strong>
                        </div>
                    </div>
                </div>
                <hr>
                <h5 class="mb-3"><i class="bi bi-clipboard-data me-2"></i>测试结果</h5>
            `;

            return infoHtml + html;

        } catch (error) {
            console.error('格式化测试结果时出错:', error);
            return `<p class="text-danger">格式化数据时发生错误: ${error.message}</p>`;
        }
    }
});
</script>
{% endblock %}
